# 版本更新日志

## [0.2.3] - 2025-01-XX

### 🎉 版本更新
- 版本号更新至 0.2.3

---

## [0.2.2] - 2025-01-XX

### 🐛 Bug修复
- **功法阁系统**: 修复领悟功法后不显示的问题
  - 重构功法列表显示逻辑，改用 `useMemo` 直接计算，确保依赖项正确更新
  - 修复 `useEffect` 依赖项比较问题，确保 `unlockedArts` 更新时列表自动刷新
  - 修复功法列表状态同步问题，新解锁的功法能够立即显示
  - 优化功法筛选逻辑，修复"未获得"筛选不正确排除已学习/已解锁功法的问题
- **物品系统**: 修复丹方类型判断和使用问题
  - 添加丹方类型的特殊判断逻辑，确保名称包含"丹方"的物品被正确识别为 `Recipe` 类型
  - 丹方判断优先级高于丹药判断，避免将"仙灵丹丹方"误判为丹药类型
  - 修复丹方在物品界面无法使用的问题，现在可以正常"研读"丹方
  - 在物品类型检查中添加丹方关键词检测，确保类型判断准确
- **装备系统**: 修复装备稀有度显示问题
  - 统一稀有度显示为中文（普通、稀有、传说、仙品），不再显示英文
  - 在装备栏位和日志输出中使用统一的 `normalizeRarityValue` 函数
  - 修复装备面板中稀有度显示为英文的问题（如 "common" 显示为 "普通"）
- **日常任务系统**: 完善任务完成判定逻辑
  - 优化 `updateQuestProgress` 函数，确保完成判定正确
  - 添加注释说明完成判定逻辑，提升代码可维护性
  - 修复边界情况处理，确保进度不会超过目标值

### 🔧 优化改进
- **功法阁界面**: 重构功法列表管理逻辑
  - 移除复杂的 `useEffect` + `useState` 组合，改用 `useMemo` 直接计算
  - 优化功法排序逻辑，已激活 > 已学习 > 已解锁 > 未解锁
  - 修复状态筛选功能，现在可以正确筛选"已学习"、"已获得"、"未获得"三种状态
  - 改进功法列表更新机制，确保数据变化时列表及时刷新
- **物品工具函数**: 优化类型推断逻辑
  - 在 `inferItemTypeAndSlot` 中添加丹方关键词检测
  - 提升物品类型判断的准确性和优先级处理
  - 优化代码结构，提升可维护性
- **稀有度工具函数**: 统一稀有度规范化逻辑
  - 在 `rarityUtils.ts` 中添加 `normalizeRarityValue` 函数
  - 统一处理英文别名到中文的转换（如 "common" → "普通"）
  - 在装备面板和日志输出中使用统一的规范化函数

### 📚 代码优化
- 重构 `CultivationModal` 组件，简化状态管理逻辑
- 优化 `itemUtils.ts` 中的物品类型推断逻辑
- 统一稀有度处理逻辑，避免代码重复
- 改进代码注释和文档，提升代码可读性

### 🎯 稳定性提升
- 修复功法列表状态不同步导致的显示问题
- 改进物品类型判断的准确性，减少类型错误
- 优化日常任务完成判定，确保逻辑正确

---

## [0.2.0] - 2025-12-16

### 功能新增
 - **存档管理器** 支持多份存档本地管理
 - **声望系统以及事件触发** 历练可以触发声望事件，可以进入对应的声望商店

### 🐛 Bug修复
- **战斗系统**: 修复回合制战斗结果处理中的类型错误
  - 修复 `handleTurnBasedBattleClose` 中访问不存在的 `playerHpAfter` 属性导致的类型错误
  - 改进战斗后血量计算逻辑，使用当前玩家状态正确计算战斗后的血量
  - 优化自动历练暂停状态管理，确保玩家死亡时正确清除暂停状态

### 🔧 优化改进
- **自动历练系统**: 改进自动历练暂停和恢复机制
  - 优化战斗结束后自动历练的恢复逻辑
  - 改进商店打开时自动历练的暂停处理
  - 确保玩家死亡时正确清除所有自动历练相关状态
  - 添加更清晰的状态管理注释，提升代码可维护性
  - 物品掉落概率平衡
  - 筛选功能完善
  - 商店完善

### 📚 代码优化
- **代码审查**: 全面审查和优化核心代码
  - 修复类型安全问题，移除不必要的类型断言
  - 优化状态更新时序，确保数据一致性
  - 改进错误处理逻辑，提升代码健壮性
  - 统一代码风格，提升可读性

### 🎯 稳定性提升
- 修复潜在的运行时错误
- 改进状态管理逻辑，减少状态不一致的情况
- 优化自动功能的状态切换，提升用户体验

---

## [0.1.7] - 2025-12-13

### 🐛 Bug修复
- **战斗系统**: 修复敌人速度比玩家快时战斗卡住的问题
  - 添加 `isProcessingEnemyTurnRef` 锁机制，防止敌人回合处理时重复触发
  - 优化 useEffect 依赖项，减少不必要的重新执行
  - 改进状态更新时序，使用 setTimeout 确保状态更新完成后再重置处理标志
  - 在组件关闭时正确清理所有 ref 和状态
- **战斗系统**: 修复秘境触发战斗初始化卡住的问题
  - 为 AI 生成敌人名称调用添加 3 秒超时保护
  - 为整个战斗初始化过程添加 10 秒超时保护
  - 使用 Promise.race 确保即使 AI API 超时也能快速回退到预设敌人名称
  - 添加超时错误提示，允许用户重试

### 🔧 优化改进
- **AI 系统**: 优化物品生成提示词，提升物品名称多样性
  - 在 systemMessage 中添加详细的物品命名规则
  - 为各类物品（草药、丹药、材料、武器、护甲、首饰、法宝）提供命名风格建议
  - 按稀有度提供命名区分指导（普通/稀有/传说/仙品）
  - 在各种事件类型中添加针对性的物品名称多样性要求
  - 强调每次生成物品时使用不同的名称组合，避免模板化重复
- **物品系统**: 规范化物品效果类型，确保描述与效果一致
  - 限制临时效果（effect）只能包含：hp、attack、defense、speed、exp
  - 其他属性（spirit、physique、maxHp、lifespan 等）自动归类为永久效果（permanentEffect）
  - 装备类物品不受此限制（因为装备效果是持续生效的）
  - 在物品生成和使用时自动应用规范化规则
  - 修复已知物品定义中的不一致问题（如凝神花）

### 📚 代码优化
- 优化战斗初始化逻辑，提升稳定性和用户体验
- 改进物品效果处理逻辑，确保数据一致性
- 增强错误处理和超时保护机制

---

## [0.1.4] - 2025-12-05

### 🐛 Bug修复
- **历练系统**: 修复AI返回JSON格式错误导致气血和修为显示NaN的问题
  - 在AI服务中添加数据验证，确保所有必需字段都有有效的数字值
  - 在历练处理逻辑中添加安全检查，防止NaN传播到玩家状态
  - 支持字符串数字的自动转换
  - 当AI返回不完整或格式错误的JSON时，使用安全的默认值（0）替代

### 🔧 优化改进
- **功法阁**: 为学习功法功能添加弹窗提醒
  - 当功法无法学习时，显示友好的弹窗提示而不是仅在日志中显示
  - 支持多种错误情况的弹窗提醒：
    - 已学习过的功法
    - 灵石不足（显示所需和当前数量）
    - 境界不足（显示所需境界和当前境界）
    - 宗门要求不满足
    - 属性要求不满足（显示所有不满足的属性详情）
  - 改进属性检查显示，将多个不满足的属性合并显示在一个弹窗中
  - 保留原有的日志记录，便于追踪

### 📚 代码优化
- 优化AI服务的数据验证逻辑，提升错误处理能力
- 改进历练核心处理逻辑，增强数据安全性

---

## [0.1.4] - 2025-12-05

### 🎉 新增功能
- **功法系统**: 添加功法品级分类系统
  - 新增天、地、玄、黄四个品级分类
  - 功法列表中显示品级标签，不同品级有不同颜色标识
  - 添加品级筛选功能，可按品级筛选功法
  - 新增20种新功法到功法池中
- **抽奖券系统**: 改为本地概率判定
  - 不再依赖AI返回抽奖券奖励
  - 每次历练有5%概率获得抽奖券（可在代码中调整1%-10%范围）
  - 获得数量在1-10张之间随机

### 🐛 Bug修复
- **功法界面**: 修复打开功法界面时React Hooks调用顺序错误
  - 将条件返回移到所有Hooks调用之后，符合React Hooks规则
  - 修复"Rendered more hooks than during the previous render"错误

### 🔧 优化改进
- **功法界面**: 优化功法列表显示
  - 添加空状态提示（无符合条件的功法时显示）
  - 改进品级标签的视觉效果
  - 添加类型筛选和品级筛选的UI优化

### 📚 代码优化
- 为所有现有功法添加了品级属性
- 更新了CultivationArt接口，添加grade字段
- 优化了抽奖券获取逻辑，提升游戏体验的稳定性

---

## [0.1.0] - 2025-12-05

### 🐛 Bug修复
- **战斗系统**: 修复回合制战斗界面技能列表无法滚动的问题
  - 技能列表添加滚动功能，现在可以查看所有可用/不可用技能
  - 丹药列表同样支持滚动显示

### 🔧 优化改进
- **Docker部署**: 完善Docker环境变量配置
  - 支持在构建时注入Vite环境变量（VITE_AI_KEY等）
  - 更新Dockerfile，添加构建参数（ARG）支持
  - 优化docker-compose.yml配置，自动读取.env文件
  - 新增镜像打包和迁移指南
  - 添加 npm 脚本实现一键构建和打包（`docker:build-and-pack`）
  - 添加 npm 脚本实现一键构建和启动（`docker:build-and-up`）

### 📚 文档更新
- 完善Docker部署文档（DOCKER.md）
  - 添加环境变量详细配置说明
  - 新增镜像打包成tar文件的完整流程
  - 补充导入/导出镜像的操作指南
  - 添加快速命令参考表（npm 脚本和 Makefile）
- 新增版本更新日志（CHANGELOG.md）
  - 记录版本更新历史
  - 提供功能计划路线图
- 新增 Makefile
  - 为习惯使用 make 命令的用户提供便利
  - 包含所有常用 Docker 操作命令
- 新增 Docker 使用示例文档（DOCKER_EXAMPLES.md）
  - 提供 7 个常见场景的完整示例
  - 包含故障排查和最佳实践
  - 详细的问答和快速参考表

### 🎨 界面优化
- **设置界面**: 添加版本号显示
  - 显示当前游戏版本（v0.1.0）
  - 添加"查看更新日志"快捷链接

---

## 版本说明

### 版本号规则
本项目遵循 [语义化版本](https://semver.org/lang/zh-CN/) 规范：
- **主版本号（MAJOR）**: 不兼容的API修改
- **次版本号（MINOR）**: 向下兼容的功能性新增
- **修订号（PATCH）**: 向下兼容的问题修正

### 更新类型标识
- 🎉 **新增功能**: 新增的游戏功能或特性
- 🐛 **Bug修复**: 修复的问题和bug
- 🔧 **优化改进**: 性能优化、用户体验改进
- 💥 **破坏性变更**: 不向下兼容的更改
- 🎨 **界面优化**: UI/UX相关改进
- 📚 **文档更新**: 文档和说明的更新
- 🔒 **安全更新**: 安全相关的修复和更新

---

## [计划中的功能]

### 游戏系统
- [ ] 更多秘境探索内容
- [ ] 灵宠进阶系统
- [ ] 宗门任务系统
- [ ] 社交功能（好友、聊天）

### 技术优化
- [ ] 游戏存档云同步
- [ ] 移动端适配优化
- [ ] 性能优化（大数据量处理）

### 界面改进
- [ ] 更多动画效果
- [ ] 可自定义主题
- [ ] 快捷键支持

---

## 历史版本

*历史版本信息将在正式发版时补充*

---

## 反馈与建议

如果您在使用过程中遇到问题或有改进建议，欢迎：
- 提交 [GitHub Issue](https://github.com/your-repo/react-xiuxian-game/issues)
- 联系开发团队

感谢您的支持！

